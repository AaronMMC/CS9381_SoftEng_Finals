<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pick-A-Plate – Cart</title>
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet"
  />
  <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />
  <link rel="stylesheet" href="css/home.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <style>
    .cart-item-card {
      background-color: #e5e7eb;
      border-radius: 16px;
      padding: 10px 14px;
      margin-bottom: 10px;
    }
    .cart-food-img {
      width: 100%;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
    }
    .qty-pill {
      border-radius: 999px;
      border: 1px solid #9ca3af;
      padding: 2px 8px;
      font-size: 0.8rem;
    }
    .checkout-btn {
      border-radius: 999px;
      font-weight: 700;
      font-size: 1rem;
    }
  </style>
</head>
<body>
<div class="container pt-3 pb-2">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="fw-bold text-green m-0">Pick-A-Plate</h2>
    <i class="bi bi-cart3 fs-2 text-green"></i>
  </div>
</div>

<hr class="mt-0 mb-2" />

<div class="container pb-5">
  <div id="cartItems"></div>

  <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
    <span class="fw-bold">Total:</span>
    <span class="fw-bold" id="cartTotal">₱ 0</span>
  </div>

  <div class="d-grid gap-2 mt-3">
    <div class="d-flex justify-content-between align-items-center">
      <span class="fw-bold">Set Location:</span>
      <input
              type="text"
              class="form-control"
              id="locationInput"
              placeholder="Enter your location"
      />
    </div>

    <button
            class="btn btn-success-custom checkout-btn"
            id="checkoutBtn"
            type="button"
    >
      Checkout!
    </button>
  </div>
</div>

<div class="bottom-nav d-flex justify-content-around align-items-center bg-white shadow-lg">
  <div class="nav-item text-center text-muted" onclick="window.location.href='dashboard.html'">
    <i class="bi bi-house-door fs-3"></i>
  </div>
  <div class="nav-item active text-center">
    <i class="bi bi-list-ul fs-3"></i>
    <div class="active-indicator"></div>
  </div>
  <div class="nav-item text-center text-muted" onclick="window.location.href='profile.html'">
    <i class="bi bi-person fs-3"></i>
  </div>
</div>

<script>
  const CART_KEY = "papCart";

  function getCart() {
    try {
      const raw = localStorage.getItem("papCart");
      return raw ? JSON.parse(raw) : [];
    } catch { return []; }
  }

  function saveCart(cart) {
    localStorage.setItem("papCart", JSON.stringify(cart));
  }

  function renderCart() {
    const container = document.getElementById("cartItems");
    const totalSpan = document.getElementById("cartTotal");
    const cart = getCart();
    container.innerHTML = "";

    if (!cart.length) {
      container.innerHTML = '<p class="text-center text-muted mt-3">Your cart is empty.</p>';
      totalSpan.textContent = "₱ 0.00";
      return;
    }

    let total = 0;
    cart.forEach((item) => {
      total += item.price * item.quantity;
      const div = document.createElement("div");
      div.className = "cart-item-card";
      div.innerHTML = `
        <div class="row g-2 align-items-center">
          <div class="col-4">
            <img src="${item.img || 'img/placeholder.png'}" class="cart-food-img" alt="${item.name}">
          </div>
          <div class="col-8">
            <div class="d-flex justify-content-between">
              <div class="fw-bold">${item.name}</div>
              <div class="fw-bold">₱ ${item.price}</div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <span class="text-muted small">Quantity</span>
              <div class="qty-pill d-inline-flex align-items-center gap-2">
                <button class="btn btn-sm p-0 border-0" data-action="dec" data-id="${item.id}">-</button>
                <span>${item.quantity}</span>
                <button class="btn btn-sm p-0 border-0" data-action="inc" data-id="${item.id}">+</button>
              </div>
            </div>
          </div>
        </div>`;
      container.appendChild(div);
    });
    totalSpan.textContent = `₱ ${total.toFixed(2)}`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const cartContainer = document.getElementById("cartItems");
    const checkoutBtn = document.getElementById("checkoutBtn");

    renderCart();

    cartContainer.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id = parseInt(btn.getAttribute("data-id"), 10);
      const cart = getCart();
      const item = cart.find((i) => i.id === id);
      if (!item) return;

      if (action === "inc") item.quantity += 1;
      else if (action === "dec") {
        item.quantity -= 1;
        if (item.quantity <= 0) cart.splice(cart.indexOf(item), 1);
      }
      saveCart(cart);
      renderCart();
    });

    checkoutBtn.addEventListener("click", async () => {
      const cart = getCart();
      if (!cart.length) { alert("Your cart is empty."); return; }

      const locationInput = document.getElementById("locationInput").value.trim();
      if (!locationInput) { alert("Please enter a location."); return; }

      const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
      if (!user) { alert("Please login first."); window.location.href="index.html"; return; }

      const itemsMap = {};
      cart.forEach(item => itemsMap[item.id] = item.quantity);

      const payload = {
          customerId: user.id,
          sellerId: cart[0].sellerId,
          items: itemsMap,
          deliveryLocation: locationInput
      };

      try {
          const resp = await fetch('/api/orders/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          if(resp.ok) {
              alert("Order Placed Successfully!");
              localStorage.removeItem(CART_KEY);
              window.location.href = "orders.html";
          } else {
              const err = await resp.text();
              alert("Order Failed: " + err);
          }
      } catch(e) {
          console.error(e);
          alert("Network Error");
      }
    });
  });
</script>
</body>
</html>